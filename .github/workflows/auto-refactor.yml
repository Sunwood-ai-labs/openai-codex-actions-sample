name: Auto Code Refactor

on:
  workflow_dispatch:
    inputs:
      target_path:
        description: 'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã®ãƒ‘ã‚¹ (ä¾‹: src/components)'
        required: true
        type: string
      refactor_type:
        description: 'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - performance
          - readability
          - security
          - modernize
      description:
        description: 'è¿½åŠ ã®æŒ‡ç¤º'
        required: false
        type: string

jobs:
  refactor-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Codex
        run: npm install -g @openai/codex
      
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: 1
        run: |
          # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿè¡Œ
          REFACTOR_INSTRUCTION="Refactor the code in ${{ github.event.inputs.target_path }} to improve ${{ github.event.inputs.refactor_type }}. "
          
          # è¿½åŠ ã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯å«ã‚ã‚‹
          if [ -n "${{ github.event.inputs.description }}" ]; then
            REFACTOR_INSTRUCTION+="Additional requirements: ${{ github.event.inputs.description }}. "
          fi
          
          REFACTOR_INSTRUCTION+="Maintain functionality while making improvements. Follow best practices and add comments explaining significant changes."
          
          codex -a auto-edit --quiet "$REFACTOR_INSTRUCTION"
      
      - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        run: |
          if [ -f "package.json" ]; then
            npm install
            npm test || echo "Tests failed - review changes before merging"
          fi
      
      - name: PRã®ä½œæˆ
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "refactor: improve ${{ github.event.inputs.refactor_type }} in ${{ github.event.inputs.target_path }}"
          title: "[Codex] Refactor ${{ github.event.inputs.target_path }} for better ${{ github.event.inputs.refactor_type }}"
          body: |
            ## ğŸ¤– è‡ªå‹•ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
            
            **å¯¾è±¡:** `${{ github.event.inputs.target_path }}`
            **ã‚¿ã‚¤ãƒ—:** ${{ github.event.inputs.refactor_type }}
            
            CodexãŒAIã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸã€‚
            
            ### å¤‰æ›´ç‚¹
            - ${{ github.event.inputs.refactor_type }}ã®æ”¹å–„ãŒè¡Œã‚ã‚Œã¾ã—ãŸ
            - ã‚³ãƒ¼ãƒ‰ã®å“è³ªãŒå‘ä¸Šã—ã¾ã—ãŸ
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
            2. ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯å‹•ä½œç¢ºèªã—ã¦ãã ã•ã„
            3. å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„
          branch: codex/refactor-${{ github.event.inputs.refactor_type }}
          delete-branch: true
