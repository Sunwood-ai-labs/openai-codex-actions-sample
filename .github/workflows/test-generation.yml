name: Test Generation

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
        required: true
        type: string
      test_type:
        description: 'ãƒ†ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - unit
          - integration
          - e2e
  push:
    branches:
      - main
    paths:
      - 'src/**/*.js'
      - 'src/**/*.py'
      - 'src/**/*.ts'
      - '!tests/**'

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Codex
        run: npm install -g @openai/codex
      
      - name: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
        id: detect-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "files=${{ github.event.inputs.target_file }}" >> $GITHUB_OUTPUT
          else
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºï¼ˆãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆï¼‰
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E 'src/.*\.(js|py|ts)$' | tr '\n' ' ')
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          fi
      
      - name: ãƒ†ã‚¹ãƒˆç”Ÿæˆ
        if: steps.detect-files.outputs.files != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: 1
        run: |
          # ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã®è¨­å®š
          TEST_TYPE="${{ github.event.inputs.test_type }}"
          if [ -z "$TEST_TYPE" ]; then
            TEST_TYPE="unit"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
          fi
          
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆ
          for file in ${{ steps.detect-files.outputs.files }}; do
            echo "Generating tests for: $file"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«åŸºã¥ã„ã¦ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ±ºå®š
            extension="${file##*.}"
            case "$extension" in
              js|ts)
                FRAMEWORK="Jest"
                ;;
              py)
                FRAMEWORK="pytest"
                ;;
              *)
                echo "Unsupported file type: $extension"
                continue
                ;;
            esac
            
            # Codexã«ãƒ†ã‚¹ãƒˆç”Ÿæˆã‚’ä¾é ¼
            codex -a auto-edit --quiet "Generate comprehensive $TEST_TYPE tests for $file using $FRAMEWORK. \
            - Create a corresponding test file in the tests/ directory \
            - Follow the naming convention appropriate for the testing framework \
            - Test all public functions, methods, and edge cases \
            - Include setup and teardown functions if needed \
            - Add mock data and fixtures where appropriate \
            - Ensure 100% code coverage where possible \
            - Include comments explaining test scenarios"
          done
      
      - name: PRã®ä½œæˆ
        if: steps.detect-files.outputs.files != ''
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "test: add ${{ github.event.inputs.test_type || 'unit' }} tests for recent changes"
          title: "[Codex] Generated ${{ github.event.inputs.test_type || 'unit' }} tests"
          body: |
            ## ğŸ§ª è‡ªå‹•ç”Ÿæˆãƒ†ã‚¹ãƒˆ
            
            **ã‚¿ã‚¤ãƒ—:** ${{ github.event.inputs.test_type || 'unit' }}
            **å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:** 
            ```
            ${{ steps.detect-files.outputs.files }}
            ```
            
            CodexãŒæœ€è¿‘ã®å¤‰æ›´ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚
            
            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ç¶²ç¾…æ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
            - ãƒ¢ãƒƒã‚¯ã®é©åˆ‡æ€§
            - ãƒ†ã‚¹ãƒˆã®èª­ã¿ã‚„ã™ã•
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
            2. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
            3. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèª
            4. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸
          branch: codex/tests-${{ github.run_number }}
          delete-branch: true
